{% extends 'complaint/complaint_base.html' %}
{% load sass_tags %}

{% block complaint-extra-head %}
<link rel="stylesheet" href="{% sass_src 'css/complaint_detail.scss' %}"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock %}

{% block complaint-content %}
<!--해당 페이지 접근 시 조회수 업데이트-->
<div style="display: none">{{ post.click }}</div>

<div class="complaint-title">{{ post.title }}</div>
<div class="complaint-summary">
    <div class="complaint-summary-unit">작성자: 익명</div>
    <div class="complaint-summary-unit">작성일: {{ post.created_at|date:"Y-m-d h:i" }}</div>
    <div class="complaint-summary-unit">조회수: {{ post.hits }}</div>
</div>
<div class="complaint-contents">
    <div class="file">{{ post.file }}</div>
    {{ post.contents }}
</div>

{% for comment in comments %}
<div class="complaint-comment">
    <div class="complaint-comment-header">
        <div class="complaint-comment-summary">
            <div class="complaint-comment-user">{{ comment.user.name }}</div>
            <div>{{ comment.created_at|date:"Y-m-d" }}</div>
            <div>{{ comment.created_at|date:"h:i" }}</div>
        </div>
        {% if comment.user == login_user %}
        <div class="complaint-comment-button-wrap">
            <input class="complaint-comment-button update-{{ comment.id }}"
                   onclick="commentUpdate('{{ comment.id }}')"
                   type="submit"
                   value="수정"/>
            <input type="submit" class="complaint-comment-button delete-{{ comment.id }}" value="삭제"/>
            <!--수정 버튼 클릭 시 생성되는 버튼-->
            <input class="complaint-comment-button cancel-{{ comment.id }}"
                   onclick="commentUpdateCancel('{{ comment.id }}')"
                   type="submit"
                   value="취소"
                   style="display: none"/>
            <input class="complaint-comment-button submit-{{ comment.id }}"
                   onclick="commentUpdateSubmit('{{ comment.id }}')"
                   type="submit"
                   value="수정"
                   style="display: none"/>
        </div>
        {% endif %}
    </div>
    <input type="text"
           class="complaint-comment-contents contents-{{ comment.id }}"
           value="{{ comment.contents }}"
           readonly/>
</div>
{% endfor %}

<form action="" method="POST">
    {% csrf_token %}
    <input type="text" name="contents" placeholder="댓글 작성"/>
    <input type="submit" value="등록"/>
</form>

<script>
    const commentUpdate = (id) => {
        let updateButton = document.querySelector(`.update-${id}`);
        let deleteButton = document.querySelector(`.delete-${id}`);
        let submitButton = document.querySelector(`.submit-${id}`);
        let cancelButton = document.querySelector(`.cancel-${id}`);
        let contents = document.querySelector(`.contents-${id}`);

        console.log(updateButton);
        updateButton.style.display = "none";
        deleteButton.style.display = "none";
        submitButton.style.display = "inline-block";
        cancelButton.style.display = "inline-block";
        contents.readOnly = false;  // 댓글 내용 수정 가능 상태로 변경
    }

    const handleSuccess = (id) => {
        let updateButton = document.querySelector(`.update-${id}`);
        let deleteButton = document.querySelector(`.delete-${id}`);
        let submitButton = document.querySelector(`.submit-${id}`);
        let cancelButton = document.querySelector(`.cancel-${id}`);
        let contents = document.querySelector(`.contents-${id}`);

        updateButton.style.display = "inline-block";
        deleteButton.style.display = "inline-block";
        submitButton.style.display = "none";
        cancelButton.style.display = "none";
        contents.readOnly = true;
    }

    const commentUpdateSubmit = (id) => {
        let contents = document.querySelector(`.contents-${id}`).value;
        let param = {
            "id": id,
            "contents": contents,
        }

        $.ajax({
            url: "{% url 'complaint:complaint_comment_update' %}",
            type: "POST",
            headers: {"X-CSRFTOKEN": "{{ csrf_token }}"},
            data: JSON.stringify(param),
            success: function (data) {
                console.log(data);

                if (data.result === "SUCCESS") {
                    handleSuccess(id)
                }
            },
            error: function () {
                alert("FAIL");
            }
        })
    }
</script>
{% endblock %}